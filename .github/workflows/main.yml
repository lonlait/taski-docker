# –§–∞–π–ª main.yml
# –ò–º—è workflow
name: Main Taski workflow
# –ü–µ—Ä–µ—á–µ–Ω—å —Å–æ–±—ã—Ç–∏–π-—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è workflow
on:
  # –°–æ–±—ã—Ç–∏–µ push –≤–æ–∑–Ω–∏–∫–∞–µ—Ç,
  # –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä GitHub
  push:
    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ –≤–µ—Ç–∫–µ main
    branches:
      - main
# –ü–µ—Ä–µ—á–µ–Ω—å –∑–∞–¥–∞—á
jobs:
  tests:
    # –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
    runs-on: ubuntu-latest
    # –ë–ª–æ–∫ services –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω docker-compose.yml
    services:
      postgres:
        image: postgres:13.10
        # –£–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã, –∏–º—è –∏ –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ,
        # –≤–µ–¥—å —ç—Ç–∞ –±–∞–∑–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–≥–æ–Ω–∞ —Ç–µ—Å—Ç–æ–≤
        env:
          POSTGRES_USER: django_user
          POSTGRES_PASSWORD: django_password
          POSTGRES_DB: django_db
        ports:
          - 5432:5432
        # –≠—Ç–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ postgres
        # –ï—Å–ª–∏ –µ—ë –Ω–µ –±—É–¥–µ—Ç, —Ç–æ —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è —Ä–∞–Ω—å—à–µ, —á–µ–º —Å–µ—Ä–≤–µ—Ä PostgreSQL
        # –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ç–µ—Å—Ç—ã –æ–ø—è—Ç—å —Ä–µ—à–∞—Ç, —á—Ç–æ –±–∞–∑—ã –Ω–µ—Ç, ‚Äî –∏ —É–ø–∞–¥—É—Ç
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
    # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞
    - name: Check out code
      uses: actions/checkout@v3
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python —Å –ø–æ–º–æ—â—å—é action
    - name: Set up Python
      uses: actions/setup-python@v4
    # –í action setup-python@v4 –ø–µ—Ä–µ–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî –≤–µ—Ä—Å–∏—é Python
      with:
        python-version: 3.12
    # –û–±–Ω–æ–≤–ª—è–µ–º pip, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º flake8 –∏ flake8-isort, 
    # —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip 
        pip install setuptools
        pip install flake8==6.0.0 flake8-isort==6.0.0
        pip install -r ./backend/requirements.txt 
    # –ó–∞–ø—É—Å–∫–∞–µ–º flake8
    - name: Test with flake8 
      run: flake8 . --exclude=backend/venv312,venv,__pycache__,*.pyc
    # –≠—Ç–æ—Ç —à–∞–≥ –¥–æ–ø–æ–ª–Ω–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
    - name: Test with flake8 and django tests
      # –ö–æ–º–∞–Ω–¥ —Å—Ç–∞–ª–æ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π; —Å—Ç–∞–≤–∏–º —Å–∏–º–≤–æ–ª | –∏ –ø–∏—à–µ–º –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
      # –î–æ–±–∞–≤–ª—è–µ–º env-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
      env:
        POSTGRES_USER: django_user
        POSTGRES_PASSWORD: django_password
        POSTGRES_DB: django_db
        # –°–µ—Ä–≤–µ—Ä –ë–î –∑–∞–ø—É—â–µ–Ω –≤ Docker, –Ω–æ –µ–≥–æ –ø–æ—Ä—Ç –ø—Ä–æ–±—Ä–æ—à–µ–Ω –Ω–∞ —Ö–æ—Å—Ç
        # –ü–æ—ç—Ç–æ–º—É –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ 127.0.0.1:5432
        DB_HOST: 127.0.0.1
        DB_PORT: 5432
      run: |
        python -m flake8 backend/ --exclude=venv312,__pycache__,*.pyc
        cd backend/
        python manage.py test 

  frontend_tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Set up nodeJS
      # –≠—Ç–æ –≥–æ—Ç–æ–≤—ã–π –≤–æ—Ä–∫—Ñ–ª–æ—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Node.js –Ω–∞ —Ä–∞–Ω–Ω–µ—Ä
      uses: actions/setup-node@v3
      with:
        # –≠—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä –≤–æ—Ä–∫—Ñ–ª–æ—É, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é Node.js
        node-version: 18

    - name: Install dependencies
      # –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
      run: |
        cd frontend/
        npm ci

    - name: Test frontend
      # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      run: |
        cd frontend/
        npm run test

  build_frontend_and_push_to_docker_hub:
    name: Push frontend Docker image to DockerHub
    runs-on: ubuntu-latest
    needs: frontend_tests
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to Docker 
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend/
          push: false
          tags: lonlait/taski_frontend:latest

  build_backend_and_push_to_docker_hub:
    name: Push backend Docker image to DockerHub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to Docker 
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./backend/
          push: false
          tags: lonlait/taski_backend:latest

  build_gateway_and_push_to_docker_hub:
    name: Push gateway Docker image to DockerHub
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to Docker 
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./gateway/
          push: false
          tags: lonlait/taski_gateway:latest

  deploy:
    runs-on: ubuntu-latest
    needs: 
      - build_backend_and_push_to_docker_hub
      - build_frontend_and_push_to_docker_hub
      - build_gateway_and_push_to_docker_hub
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
    # –ö–æ–ø–∏—Ä—É–µ–º docker-compose.production.yml –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-—Å–µ—Ä–≤–µ—Ä
    - name: Copy files via ssh
      uses: appleboy/scp-action@master
      # –ü–µ—Ä–µ–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è action appleboy/scp-action:
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        source: "docker-compose.production.yml,frontend/,backend/,gateway/"
        target: "taski"
    - name: Executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        # –ü–∞—Ä–∞–º–µ—Ç—Ä script –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ action appleboy/ssh-action –∫–æ–º–∞–Ω–¥—ã,
        # –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, 
        # —Å –∫–æ—Ç–æ—Ä—ã–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        script: |
          cd taski
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å
          ls -la
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –æ—á–∏—â–∞–µ–º –ø–æ—Ä—Ç—ã
          sudo docker compose -f docker-compose.production.yml down
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          sudo docker stop $(sudo docker ps -q) 2>/dev/null || true
          sudo docker rm $(sudo docker ps -aq) 2>/dev/null || true
          # –û—á–∏—â–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã
          sudo docker system prune -f
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç 8080 —Å–≤–æ–±–æ–¥–µ–Ω
          sudo netstat -tlnp | grep :8080 || echo "Port 8080 is free"
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ volumes –µ—Å–ª–∏ –µ—Å—Ç—å
          sudo docker volume rm taski_static taski_postgres_data 2>/dev/null || true
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã –ª–æ–∫–∞–ª—å–Ω–æ
          sudo docker build -t lonlait/taski_frontend:latest frontend/
          sudo docker build -t lonlait/taski_backend:latest backend/
          sudo docker build -t lonlait/taski_gateway:latest gateway/
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          sudo docker compose -f docker-compose.production.yml up -d
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          sleep 20
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          sudo docker compose -f docker-compose.production.yml ps
          # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–±–æ—Ä —Å—Ç–∞—Ç–∏–∫–∏
          sudo docker compose -f docker-compose.production.yml exec -T backend python manage.py migrate
          sudo docker compose -f docker-compose.production.yml exec -T backend python manage.py collectstatic --noinput
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Å–æ–±—Ä–∞–ª–∏—Å—å
          sudo docker compose -f docker-compose.production.yml exec -T backend ls -la /app/collected_static/
          # –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
          sudo docker compose -f docker-compose.production.yml exec -T backend sh -c "if [ -d /app/collected_static ] && [ \"\$(ls -A /app/collected_static)\" ]; then cp -r /app/collected_static/* /app/backend_static/; else echo 'No static files to copy'; fi"
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –¥–æ–º–µ–Ω (HTTP –∏ HTTPS)
          sudo tee /etc/nginx/sites-available/gopto.hopto.org << 'EOF'
          server {
              listen 80;
              server_name gopto.hopto.org;
              
              location / {
                  proxy_pass http://localhost:8000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          
          server {
              listen 443 ssl;
              server_name gopto.hopto.org;
              
              ssl_certificate /etc/letsencrypt/live/gopto.hopto.org/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/gopto.hopto.org/privkey.pem;
              
              location / {
                  proxy_pass http://localhost:8000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          EOF
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          sudo ln -sf /etc/nginx/sites-available/gopto.hopto.org /etc/nginx/sites-enabled/
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
          sudo nginx -t
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx
          sudo systemctl reload nginx
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏ –ø–æ–ª—É—á–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏)
          if [ ! -f /etc/letsencrypt/live/gopto.hopto.org/fullchain.pem ]; then
            sudo certbot --nginx -d gopto.hopto.org --non-interactive --agree-tos --email admin@gopto.hopto.org || echo "SSL certificate setup skipped"
          fi

  send_message:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
    - name: Send message
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          üöÄ Taski —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç!
          
          üåê –î–æ–º–µ–Ω: https://gopto.hopto.org
          üìä –°—Ç–∞—Ç—É—Å: ‚úÖ –£—Å–ø–µ—à–Ω–æ
          üïê –í—Ä–µ–º—è: ${{ github.event.head_commit.timestamp }}
          
          –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}